<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>Prebid VideoJS – преролл + каждые 30 с</title>

    <!-- Prebid (dev build, только для теста) -->
    <script async src="https://cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"></script>

    <!-- VideoJS + IMA -->
    <link href="https://vjs.zencdn.net/7.20.2/video-js.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.9.0/videojs-contrib-ads.css"
        rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.20.2/video.min.js"></script>
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.9.0/videojs-contrib-ads.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/1.11.0/videojs.ima.js"></script>

    <style>
        body {
            margin: 0;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh
        }

        .example-video-container {
            width: 75vw;
            max-width: 960px
        }

        video {
            width: 100%;
            height: 100%
        }
    </style>
</head>

<body>
    <div class="example-video-container">
        <video-js id="player" class="vjs-big-play-centered"></video-js>
    </div>

    <script>
        /*****************************************************************
         * 1 — adUnit (можно добавить других bidders)
         *****************************************************************/
        const adUnits = [{
            code: 'div-gpt-ad-video-0',
            mediaTypes: { video: {} },
            video: { divId: 'player' },
            bids: [{ bidder: 'ix', params: { siteId: 'YOUR_SITE_ID' } }]   // ← замените на свои
        }];

        /*****************************************************************
         * 2 — Prebid setup
         *****************************************************************/
        const pbjs = window.pbjs = window.pbjs || {};
        pbjs.que = pbjs.que || [];

        pbjs.que.push(function () {
            pbjs.setConfig({
                video: {
                    providers: [{
                        divId: 'player',
                        vendorCode: 2,
                        playerConfig: {
                            params: {
                                adPluginConfig: { adLabel: 'Prebid Video', numRedirects: 10 },
                                vendorConfig: { controls: true, autoplay: true, preload: 'auto' }
                            }
                        },
                        adServer: {
                            vendorCode: 'gam',
                            baseAdTagUrl: 'https://pubads.g.doubleclick.net/gampad/ads?' +
                                'iu=/21775744923/external/single_preroll_skippable' +
                                '&sz=640x480&gdfp_req=1&output=vast&unviewed_position_start=1' +
                                '&env=vp&impl=s&correlator='
                        }
                    }]
                },
                cache: { url: 'https://prebid.adnxs.com/pbc/v1/cache' },

                /* ---------- DEMO-VAST, убрать в продакшне ---------- */
                debugging: {
                    enabled: true,
                    intercept: [{
                        when: { adUnitCode: 'div-gpt-ad-video-0' },
                        then: {
                            cpm: 3.20,
                            mediaType: 'video',
                            vastXml:
                                '<VAST version="3.0"><Ad id="1"><InLine><AdSystem>Demo</AdSystem>' +
                                '<AdTitle>Sample</AdTitle><Creatives><Creative><Linear>' +
                                '<Duration>00:00:15</Duration><MediaFiles>' +
                                '<MediaFile type="video/mp4" delivery="progressive" width="640" height="360">' +
                                'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4' +
                                '</MediaFile></MediaFiles></Linear></Creative></Creatives></InLine></Ad></VAST>'
                        }
                    }]
                }
            });

            /***************** ПЕРВЫЙ (preroll) аукцион *****************/
            pbjs.addAdUnits(adUnits);
            pbjs.requestBids(adUnits);

            /***************** player ready → контент + mid-roll цикл *****/
            pbjs.onEvent('videoSetupComplete', () => {
                const player = videojs('player');

                player.loadMedia({
                    src: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    type: 'video/mp4',
                    id: 'bbb',
                    title: 'Big Buck Bunny'
                });

                /* --------- 30-секундный таймер ------------ */
                let nextAdTime = 30;   // первая пауза
                let adOrRequest = false; // false → контент свободен, можно запускать

                /* adstart → контент прерван, реклама началась */
                player.on('adstart', () => adOrRequest = true);

                /* adend   → реклама закончилась, снимаем блок и планируем след. паузу */
                player.on('adend', () => {
                    adOrRequest = false;
                    nextAdTime += 30;    // следующая пауза
                });

                /* Если аукцион вернулся без video-ставки */
                pbjs.onEvent('videoBidError', () => {
                    adOrRequest = false; // снимем блокировку
                    nextAdTime += 30;    // сдвинем, чтобы снова попробовать позже
                });

                /* Каждое обновление позиции контента */
                player.on('timeupdate', () => {
                    if (!adOrRequest && player.currentTime() >= nextAdTime) {
                        console.log('⏰ mid-roll @', Math.floor(player.currentTime()), 'сек.');
                        adOrRequest = true;              // блокируем до ответа аукциона
                        pbjs.requestBids(adUnits);       // <<< та самая «ручка» показа рекламы
                    }
                });
            });
        });
    </script>
</body>

</html>