<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <title>Video.js + Prebid Video + GAM demo</title>

    <!-- Video.js -->
    <link href="https://vjs.zencdn.net/8.11.4/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.11.4/video.min.js"></script>

    <!-- IMA SDK + плагины -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-ads@6"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-ima@2"></script>
    <!-- ad-schedule-plugin удобно описывает mid-roll-ы -->
    <script src="https://cdn.jsdelivr.net/npm/@video-js/ad-schedule-plugin"></script>

    <!-- Google Publisher Tag -->
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

    <!-- Prebid.js (соберите custom-build: dfpVideo + сопоставимые bidder-модули) -->
    <script async
        src="https://cdn.jsdelivr.net/gh/iammacheta/prebidjs-video-code@c6d463e3404bdbf5099e45e39f18fe0659663dfd/prebid.js"></script>

    <style>
        body {
            margin: 0;
            background: #000
        }

        .video-js {
            width: 100%;
            height: 56.25vw;
            max-height: 100vh
        }
    </style>
</head>

<body>

    <video id="content_video" class="video-js vjs-default-skin" playsinline muted autoplay preload="auto" controls>
        <!-- контентный источник; нужен даже для autostart -->
        <source src="https://vjs.zencdn.net/v/oceans.mp4" type="video/mp4" />
    </video>

    <script>
        /* ---------- 1. Конфигурация Prebid ----------- */
        const adUnit = {
            code: 'instream_adunit',
            mediaTypes: {
                video: {
                    context: 'instream',
                    playerSize: [640, 360],
                    mimes: ['video/mp4'],
                    protocols: [2, 3, 5],      // VAST 2/3/4
                    api: [2]                 // VPAID 2 JS
                }
            },
            bids: [
                {
                    bidder: 'appnexus',
                    params: {
                        placementId: 13232361
                    }
                },
                {
                    bidder: "adagio",
                    params: {
                        organizationId: "1458",
                        site: "mobalytics-gg"
                    }
                },
                {
                    bidder: "oms",
                    params: {
                        publisherId: "21048"
                    }
                },
                {
                    bidder: "onetag",
                    params: {
                        pubId: "80ac484cd63fd7e",
                        ext: {
                            placement_name: "web-video"
                        }
                    }
                },
                {
                    bidder: "unruly",
                    params: {
                        siteId: 287980
                    }
                },
                {
                    bidder: "vidazoo",
                    params: {
                        cId: "67ee7a23e3011c328b218c68",
                        pId: "59ac17c192832d0011283fe3",
                        subDomain: "exchange"
                    }
                }
            ]
        };

        /* ---------- 2. Инициализируем Video.js + IMA ----------- */
        const player = videojs('content_video', { muted: true, autoplay: 'muted', controls: true });
        player.ready(() => {
            // IMA должен один раз инициализироваться по пользовательскому действию
            player.one('play', () => player.ima.initializeAdDisplayContainer());
        });

        /* ---------- 3. Вспом. функция: собираем URL для GAM ----------- */
        function buildGamUrl() {
            // Получаем таргетинги от Prebid в формате "k=v&k2=v2"
            const custParams = pbjs.getAdserverTargeting()
                ? encodeURIComponent(Object.entries(pbjs.getAdserverTargeting()[adUnit.code] || {})
                    .map(([k, v]) => `${k}=${v}`).join('&'))
                : '';

            // VMAP с правилом mid-roll каждые 30 с
            return `https://pubads.g.doubleclick.net/gampad/ads?` +
                `iu=//19968336/prebid_cache_video_adunit` +        // Placement в GAM
                `&description_url=https%3A%2F%iammacheta.github.io` +
                `&env=vp&output=xml_vmap1&ad_rule=1` +     // VMAP+Ad Rules
                `&cmsid=YOUR_CMSID&vid=0&correlator=${Date.now()}` +
                (custParams ? `&cust_params=${custParams}` : '');
        }

        /* ---------- 4. Функция, которая делает аукцион и запрашивает рекламу ----------- */
        function requestAds() {
            pbjs.que.push(() => {
                pbjs.addAdUnits([adUnit]);
                pbjs.requestBids({
                    timeout: 1500,
                    adUnitCodes: [adUnit.code],
                    bidsBackHandler: function () {
                        const vastUrl = buildGamUrl();
                        player.ima({
                            adTagUrl: vastUrl,
                            timeout: 3000,
                            debug: false
                        });
                        // Запрос самой рекламы
                        player.ima.requestAds();
                    }
                });
            });
        }

        /* ---------- 5. Первая загрузка + расписание mid-roll-ов ----------- */
        player.one('loadedmetadata', () => {
            requestAds(); // преролл

            // Каждые 30 сек — новый аукцион + mid-roll
            let nextBreak = 30;
            player.on('timeupdate', () => {
                if (player.currentTime() >= nextBreak) {
                    nextBreak += 30;
                    requestAds();
                }
            });
        });
    </script>
</body>

</html>