<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>Prebid VideoJS – преролл + каждые 30 с</title>
    
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js" crossorigin="anonymous"></script>

    <!-- Prebid build -->
    <script async
        src="https://cdn.jsdelivr.net/gh/iammacheta/prebidjs-video-code@c6d463e3404bdbf5099e45e39f18fe0659663dfd/prebid.js"></script>

    <!-- VideoJS + IMA -->
    <link href="https://vjs.zencdn.net/7.20.2/video-js.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.9.0/videojs-contrib-ads.css"
        rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.20.2/video.min.js"></script>
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.9.0/videojs-contrib-ads.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/1.11.0/videojs.ima.js"></script>

    <style>
        body {
            margin: 0;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* ▸ контейнер для плеера (точно 400 × 225) */
        .example-video-container {
            width: 400px;
            height: 225px;
        }

        /* ▸ сам плеер растягиваем на весь контейнер */
        .example-video-container .video-js,
        .example-video-container video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="example-video-container">
        <!-- width / height для надёжности + CSS-резерв -->
        <video-js id="player" class="vjs-big-play-centered" width="400" height="225"></video-js>
    </div>

    <script>
        /*****************************************************************
         * 1 — adUnit (можно добавить других bidders)
         *****************************************************************/
        const adUnits = [{
            code: 'div-gpt-ad-prebid-video-0',
            mediaTypes: { video: {} },
            video: { divId: 'player' },
            bids: [
                { bidder: 'appnexus', params: { placementId: 13232361 } },
                { bidder: 'adagio', params: { organizationId: '1458', site: 'mobalytics-gg' } },
                { bidder: 'oms', params: { publisherId: '21048' } },
                { bidder: 'onetag', params: { pubId: '80ac484cd63fd7e', ext: { placement_name: 'web-video' } } },
                { bidder: 'unruly', params: { siteId: 287980 } },
                { bidder: 'vidazoo', params: { cId: '67ee7a23e3011c328b218c68', pId: '59ac17c192832d0011283fe3', subDomain: 'exchange' } }
            ]
        }];

        /*****************************************************************
         * 2 — Prebid setup
         *****************************************************************/
        const pbjs = window.pbjs = window.pbjs || {};
        pbjs.que = pbjs.que || [];

        pbjs.que.push(function () {
            pbjs.setConfig({
                video: {
                    providers: [{
                        divId: 'player',
                        vendorCode: 2,
                        playerConfig: {
                            params: {
                                adPluginConfig: { adLabel: 'Prebid Video', numRedirects: 10 },
                                vendorConfig: { controls: true, autoplay: true, preload: 'auto' }
                            }
                        },
                        adServer: {
                            vendorCode: 'gam',
                            baseAdTagUrl:
                                'https://pubads.g.doubleclick.net/gampad/ads?' +
                                'iu=/21775744923/external/single_preroll_skippable' +
                                '&sz=640x480&gdfp_req=1&output=vast&unviewed_position_start=1' +
                                '&env=vp&impl=s&correlator='
                        }
                    }]
                },
                cache: { url: 'https://prebid.adnxs.com/pbc/v1/cache' },

            });

            /***************** ПЕРВЫЙ (preroll) аукцион *****************/
            pbjs.addAdUnits(adUnits);
            pbjs.requestBids(adUnits);

            /***************** player ready → контент + mid-roll цикл *****/
            pbjs.onEvent('videoSetupComplete', () => {
                const player = videojs('player');

                player.loadMedia({
                    src: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    type: 'video/mp4',
                    id: 'bbb',
                    title: 'Big Buck Bunny'
                });

                /* --------- 30-секундный таймер ------------ */
                let nextAdTime = 30;   // первая пауза
                let adOrRequest = false; // false → контент свободен, можно запускать

                /* adstart → контент прерван, реклама началась */
                player.on('adstart', () => adOrRequest = true);

                /* adend   → реклама закончилась, снимаем блок и планируем след. паузу */
                player.on('adend', () => {
                    adOrRequest = false;
                    nextAdTime += 30;    // следующая пауза
                });

                /* Если аукцион вернулся без video-ставки */
                pbjs.onEvent('videoBidError', () => {
                    adOrRequest = false; // снимем блокировку
                    nextAdTime += 30;    // сдвинем, чтобы снова попробовать позже
                });

                /* Каждое обновление позиции контента */
                player.on('timeupdate', () => {
                    if (!adOrRequest && player.currentTime() >= nextAdTime) {
                        console.log('⏰ mid-roll @', Math.floor(player.currentTime()), 'сек.');
                        adOrRequest = true;              // блокируем до ответа аукциона
                        pbjs.requestBids(adUnits);       // <<< та самая «ручка» показа рекламы
                    }
                });
            });
        });
    </script>
</body>

</html>